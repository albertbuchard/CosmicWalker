!function(root,factory){"object"==typeof exports&&"object"==typeof module?module.exports=factory(require("experiment-js"),require("experiment-babylon-js"),require("lodash"),require("experiment-boxes"),require("experiment-mathjs"),require("jQuery")):"function"==typeof define&&define.amd?define("walker",["experiment-js","experiment-babylon-js","lodash","experiment-boxes","experiment-mathjs","jQuery"],factory):"object"==typeof exports?exports.walker=factory(require("experiment-js"),require("experiment-babylon-js"),require("lodash"),require("experiment-boxes"),require("experiment-mathjs"),require("jQuery")):root.walker=factory(root.experiment,root.BABYLON,root._,root.experimentBoxes,root.math,root.jQuery)}(this,function(__WEBPACK_EXTERNAL_MODULE_0__,__WEBPACK_EXTERNAL_MODULE_1__,__WEBPACK_EXTERNAL_MODULE_2__,__WEBPACK_EXTERNAL_MODULE_3__,__WEBPACK_EXTERNAL_MODULE_16__,__WEBPACK_EXTERNAL_MODULE_17__){return function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}var installedModules={};return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.i=function(value){return value},__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{configurable:!1,enumerable:!0,get:getter})},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=6)}([function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_0__},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_1__},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_2__},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_3__},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(_experimentJs.Array.isArray(arr)){for(var i=0,arr2=(0,_experimentJs.Array)(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return _experimentJs.Array.from(arr)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.setTextLoaderValue=exports.showLoader=exports.hideLoader=exports.setLoaderValue=exports.explode=exports.hideCross=exports.showCross=exports.setViewForDirection=exports.hidePointSpheres=exports.showPointSpheres=exports.updatePoints=exports.placePoints=exports.checkIdleAndConnection=exports.setBlackScreen=exports.setMargins=exports.highlightPosition=exports.addButton=void 0;var _lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),placePoints=function(){var points=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];if(0!==points.length){var stateManager=this.stateManager,pointSpheres=stateManager.get("pointSpheres",[]),redraw=!1;points.length!==pointSpheres.length&&(redraw=!0);for(var tempPointSpheres=[],i=0;i<points.length;i++){var point=points[i];if((0,_experimentJs.hasConstructor)(_experimentJs.Array,point)){var pointSphere=void 0;pointSphere=redraw||pointSpheres.length<i?_experimentBabylonJs2.default.Mesh.CreateSphere("sphere"+i,32,.5,this.scene):pointSpheres[i],pointSphere.position=new(Function.prototype.bind.apply(_experimentBabylonJs2.default.Vector3,[null].concat(_toConsumableArray(point)))),tempPointSpheres.push(pointSphere)}}stateManager.set("pointSpheres",tempPointSpheres)}},updatePoints=function(points){if(0!==points.length){var stateManager=this.stateManager,pointSpheres=stateManager.get("pointSpheres",[]);if(pointSpheres.length!==points.length)stateManager.call("placePoints",points);else for(var i=0;i<pointSpheres.length;i++){var point=points[i];(0,_experimentJs.hasConstructor)(_experimentJs.Array,point)&&(pointSpheres[i].position=new(Function.prototype.bind.apply(_experimentBabylonJs2.default.Vector3,[null].concat(_toConsumableArray(point)))))}}},hidePointSpheres=function(){var stateManager=this.stateManager,pointSpheres=stateManager.get("pointSpheres",[]),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=pointSpheres[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var pointSphere=_step.value;(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Mesh,pointSphere)&&(pointSphere.visibility=!1)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}},showPointSpheres=function(){var stateManager=this.stateManager,pointSpheres=stateManager.get("pointSpheres",[]),_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=pointSpheres[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var pointSphere=_step2.value;(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Mesh,pointSphere)&&(pointSphere.visibility=!0)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}},setLoaderValue=function(){var value=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,loader=this.stateManager.get("loader",null);null===loader?this.stateManager.call("showLoader",value):loader.value=value},setTextLoaderValue=function(){var value=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"0",textLoader=this.stateManager.get("textLoader",null);null===textLoader?(textLoader=new _experimentBabylonJs2.default.Text2D((0,_experimentJs.String)(value),{parent:this.stateManager.get("GUI"),fontName:"20px Arial",marginAlignment:"v: bottom, h: center",fontSignedDistanceField:!0}),_lodash2.default.extend(textLoader.margin,{leftPixels:0,rightPixels:0,topPixels:0,bottomPixels:51}),this.stateManager.set("textLoader",textLoader)):textLoader.text=(0,_experimentJs.String)(value)},hideLoader=function(){var textLoader=this.stateManager.get("textLoader",null);null!==textLoader&&(textLoader.levelVisible=!1);var loader=this.stateManager.get("loader",null);null!==textLoader&&(loader.levelVisible=!1)},showLoader=function(){var value=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,guiCanvas=this.stateManager.get("GUI"),loader=this.stateManager.get("loader",null);null!==loader?loader.levelVisible=!0:(loader=new _experimentJs.Loader({parent:guiCanvas,size:new _experimentBabylonJs2.default.Size(69,23),border:_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(.7,.7,.7,1)),marginAlignment:"v:bottom, h:center",borderThickness:1}),loader.value=value,loader.opacity=1,_lodash2.default.extend(loader.margin,{leftPixels:.5,rightPixels:0,topPixels:0,bottomPixels:53}),this.stateManager.set("loader",loader));var textLoader=this.stateManager.get("textLoader",null);null!==textLoader?textLoader.levelVisible=!0:this.stateManager.call("setLoaderValue",value)},setViewForDirection=function(_ref){var _ref$direction=_ref.direction,direction=void 0===_ref$direction?null:_ref$direction,scene=this.scene,camera=scene.activeCamera;if(null===direction)return"GlobalFunctions.setViewForDirection: direction is null";var xPos="LEFT"===direction?-50:50;return camera.position=new _experimentBabylonJs2.default.Vector3(xPos,0,0),camera.setTarget(new _experimentBabylonJs2.default.Vector3.Zero),"View changed"},addButton=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.taskObject)throw new Error("stateManager.addButton: this.taskObject is undefined");var stateManager=this.stateManager,canvas=stateManager.get("elements2D").canvas,baseOptions={id:"button"+stateManager.timeInMs,text:"text",x:50,y:50,width:100,height:50,fill:_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(.8,.8,.8,1)),clickEventData:null,fontName:"30pt Arial",baseOpacity:.8,hoverOpacity:1,zOrder:-.5,marginAlignment:null,fontSignedDistanceField:!0,margin:{},padding:{},parent:canvas};baseOptions.margin.leftPixels=0,baseOptions.margin.rightPixels=0,baseOptions.margin.topPixels=0,baseOptions.margin.bottomPixels=0,baseOptions.padding.leftPixels=0,baseOptions.padding.rightPixels=0,baseOptions.padding.topPixels=0,baseOptions.padding.bottomPixels=0,baseOptions.margin=_lodash2.default.extend(baseOptions.margin,options.margin),baseOptions.padding=_lodash2.default.extend(baseOptions.padding,options.padding),options.margin=baseOptions.margin,options.padding=baseOptions.padding,options=_lodash2.default.extend(baseOptions,options);var buttonOptions={},margin={},padding={};null===options.marginAlignment?buttonOptions={parent:options.parent,id:options.id,x:options.x,y:options.y,width:options.width,height:options.height,fill:options.fill,zOrder:options.zOrder,roundRadius:0,children:[new _experimentBabylonJs2.default.Text2D(options.text,{fontName:options.fontName,marginVAlignment:"v: center",fontSignedDistanceField:options.fontSignedDistanceField,marginHAlignment:3})]}:(buttonOptions={parent:options.parent,id:options.id,width:options.width,height:options.height,fill:options.fill,zOrder:options.zOrder,marginAlignment:options.marginAlignment,roundRadius:0,children:[new _experimentBabylonJs2.default.Text2D(options.text,{fontName:options.fontName,marginVAlignment:"v: center",fontSignedDistanceField:options.fontSignedDistanceField,marginHAlignment:3})]},margin=options.margin,padding=options.padding);var buttonRect=new _experimentBabylonJs2.default.Rectangle2D(buttonOptions);return buttonRect.opacity=options.baseOpacity,null!==margin&&(buttonRect.margin.rightPixels=options.margin.rightPixels,buttonRect.margin.leftPixels=options.margin.leftPixels,buttonRect.margin.topPixels=options.margin.topPixels,buttonRect.margin.bottomPixels=options.margin.bottomPixels),null!==padding&&(buttonRect.padding.rightPixels=padding.rightPixels,buttonRect.padding.leftPixels=padding.leftPixels,buttonRect.padding.topPixels=padding.topPixels,buttonRect.padding.bottomPixels=padding.bottomPixels),buttonRect.pointerEventObservable.add(function(){buttonRect.opacity=options.hoverOpacity},_experimentBabylonJs2.default.PrimitivePointerInfo.PointerOver),buttonRect.pointerEventObservable.add(function(){buttonRect.opacity=options.baseOpacity},_experimentBabylonJs2.default.PrimitivePointerInfo.PointerOut),null!==options.clickEventData&&options.clickEventData.constructor===_experimentJs.EventData&&buttonRect.pointerEventObservable.add(function(){options.clickEventData.happenedAt=stateManager.timeInMs,options.clickEventData.data.button=buttonRect.id,stateManager.addEvent(options.clickEventData)},_experimentBabylonJs2.default.PrimitivePointerInfo.PointerUp),buttonRect},setMargins=function(prim,margin){prim.margin.rightPixels=margin.rightPixels,prim.margin.leftPixels=margin.leftPixels,prim.margin.topPixels=margin.topPixels,prim.margin.bottomPixels=margin.bottomPixels},showCross=function(){var crossSheet=this.taskObject.cloneAssetIntoScene(this.R.get.crossSheet,this.scene);crossSheet.hasAlpha=!0;var guiCanvas=this.stateManager.get("GUI"),cross=this.stateManager.get("cross",null);(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Sprite2D,cross)&&cross.dispose(),cross=new _experimentBabylonJs2.default.Sprite2D(crossSheet,{parent:guiCanvas,id:"cross",marginAlignment:"v: center, h: center",spriteSize:new _experimentBabylonJs2.default.Size(20,20),spriteLocation:new _experimentBabylonJs2.default.Vector2(0,0)}),cross.spriteFrame=0,cross.levelVisible=!0,this.stateManager.set("cross",cross)},hideCross=function(){var cross=this.stateManager.get("cross",null);null!==cross&&(cross.levelVisible=!1)},highlightPosition=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("stateManager.highlightPosition: this.stateManager is undefined");if(void 0===options.position)throw new Error("stateManager.highlightPosition: options.position is undefined");return this.stateManager.promise("drawTiles",{hightlight:options.position,type:void 0!==options.type?options.type:"prediction"})},explode=function(_ref2){var _ref2$meshes=_ref2.meshes,meshes=void 0===_ref2$meshes?null:_ref2$meshes;if(null===meshes)return"No mesh given";var parameters=this.R.get.parameters.explosion,explosionTexture=this.taskObject.cloneAssetIntoScene(this.R.get.explosionTexture,this.scene);explosionTexture.hasAlpha=!0;var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_iterator3=meshes[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0){var mesh=_step3.value,particleSystem=new _experimentBabylonJs2.default.ParticleSystem("particles",1e3,this.scene);particleSystem.particleTexture=explosionTexture,particleSystem.emitter=mesh,particleSystem.minEmitBox=new _experimentBabylonJs2.default.Vector3(0,0,0),particleSystem.maxEmitBox=new _experimentBabylonJs2.default.Vector3(0,0,0),particleSystem.color1=new _experimentBabylonJs2.default.Color4(.7,.8,1,.8),particleSystem.color2=new _experimentBabylonJs2.default.Color4(.2,.5,1,.7),particleSystem.colorDead=new _experimentBabylonJs2.default.Color4(0,0,.2,0),particleSystem.minSize=parameters.minSize,particleSystem.maxSize=parameters.maxSize,particleSystem.minLifeTime=parameters.minLifeTime,particleSystem.maxLifeTime=parameters.maxLifeTime,particleSystem.emitRate=parameters.emitRate,particleSystem.blendMode=_experimentBabylonJs2.default.ParticleSystem.BLENDMODE_ONEONE,particleSystem.gravity=new _experimentBabylonJs2.default.Vector3(0,0,0),particleSystem.direction1=new _experimentBabylonJs2.default.Vector3(-5,5,5),particleSystem.direction2=new _experimentBabylonJs2.default.Vector3(5,-5,-5),particleSystem.minAngularSpeed=0,particleSystem.maxAngularSpeed=Math.PI,particleSystem.minEmitPower=parameters.minEmitPower,particleSystem.maxEmitPower=parameters.maxEmitPower,particleSystem.updateSpeed=.025,particleSystem.targetStopDuration=.5,particleSystem.disposeOnStop=!0,particleSystem.start()}}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}return"Exploded"},setBlackScreen=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,baseOptions={on:!0};options=_lodash2.default.extend(baseOptions,options);var elements2D=this.stateManager.getGlobal("elements2D"),canvas=elements2D.canvas;if(!_lodash2.default.has(elements2D,"blackScreen")){var blackScreen=new _experimentBabylonJs2.default.Rectangle2D({parent:canvas,id:"blackScreen",position:new _experimentBabylonJs2.default.Vector2(0,0),width:canvas.size.width,height:canvas.size.height,zOrder:0});elements2D.blackScreen=blackScreen}options.on?elements2D.blackScreen.opacity=1:elements2D.blackScreen.opacity=0},checkIdleAndConnection=function(){var _this=this,_ref3=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{deferred:new _experimentJs.Deferred,returnToState:null},_ref3$deferred=_ref3.deferred,deferred=void 0===_ref3$deferred?new _experimentJs.Deferred:_ref3$deferred,_ref3$returnToState=_ref3.returnToState,returnToState=void 0===_ref3$returnToState?null:_ref3$returnToState,stateManager=this.stateManager,R=this.R,dataManager=this.dataManager,connection=this.connection;return stateManager.get("shouldCheckTime",!1)?dataManager.query("getLastInteraction",null,connection,deferred).then(function(r){var delay=stateManager.timeInMs-r.lastInteraction,delayMin=delay/6e4;delay>12e5?((0,_experimentJs.debugWarn)("running.goToNextPosition: idle for too long"),stateManager.set("endReason","You were idle for more than 20 min: "+delayMin+" min"),stateManager.goToState(R.get.states_end)):null!==returnToState&&stateManager.currentStateKey!==returnToState&&stateManager.goToState(returnToState)}).catch(function(){(0,_experimentJs.debugWarn)("running.goToNextPosition: lost connection"),returnToState=returnToState||stateManager.currentStateKey,stateManager.currentStateKey!==R.get.states_idle&&(stateManager.call("hideAll"),stateManager.onNext(_this.R.get.events_unfrozen,function(){stateManager.call("showAll")}),_this.state.freeze(),stateManager.goToState(R.get.states_idle)),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:returnToState})})}):Promise.resolve()};exports.addButton=addButton,exports.highlightPosition=highlightPosition,exports.setMargins=setMargins,exports.setBlackScreen=setBlackScreen,exports.checkIdleAndConnection=checkIdleAndConnection,exports.placePoints=placePoints,exports.updatePoints=updatePoints,exports.showPointSpheres=showPointSpheres,exports.hidePointSpheres=hidePointSpheres,exports.setViewForDirection=setViewForDirection,exports.showCross=showCross,exports.hideCross=hideCross,exports.explode=explode,exports.setLoaderValue=setLoaderValue,exports.hideLoader=hideLoader,exports.showLoader=showLoader,exports.setTextLoaderValue=setTextLoaderValue},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _jquery=__webpack_require__(17),_jquery2=_interopRequireDefault(_jquery),_lodash=__webpack_require__(2),_experimentJs=(_interopRequireDefault(_lodash),__webpack_require__(0)),_experimentBoxes=__webpack_require__(3),_config=__webpack_require__(7),_MainScene=__webpack_require__(8),_MainScene2=_interopRequireDefault(_MainScene);window.taskObject=null,window.calibrator=null;var defferedDomLoaded=new _experimentJs.Deferred;if(document.addEventListener("DOMContentLoaded",function(){defferedDomLoaded.resolve()}),"undefined"!=typeof window){var scripts=document.getElementsByTagName("script");if(scripts.length){var assetsFolderFullpath=scripts[scripts.length-1].src,delimiterIndices=assetsFolderFullpath.indicesOf("/");window.assetsFolderFullpath=assetsFolderFullpath.substr(0,delimiterIndices[delimiterIndices.length-2])}else window.assetsFolderFullpath="./"}var R=new _experimentJs.RessourceManager;window.p1=defferedDomLoaded.promise,window.p2=R.addFiles(window.assetsFolderFullpath+"/assets/yaml/ressources.yaml",window.assetsFolderFullpath+"/assets/json/randomized_trials_final_pure_impure_with_training.json"),window.loadingPromise=Promise.all([window.p1,window.p2]),window.loadingPromise.then(function(){function loginForm(){var fields={userId:{type:"input",constraints:"length:3,300",authorizedValues:null,parent:null,title:"User Id:"},password:{type:"password",constraints:"length:3,300; score: 20",authorizedValues:null,parent:null,title:"Enter your password, if you are new here you are free to pick one !"}},options={fields:fields,title:"Login Form",format:"topCentralSmall",callback:function(fields){(0,_experimentJs.debuglog)({endpoint:endpoint,credentials:{userId:fields.userId.value,password:fields.password.value}})}},form=new _experimentBoxes.SmartForm(options);form.buttonText="OK";var R=taskObject.context.R,stateManager=taskObject.context.stateManager;return stateManager&&stateManager.goToState(R.get.states_active),form}window.DEBUG_MODE_ON=_config.DEBUG_MODE_ON;var taskObject=new _experimentJs.TaskObject((0,_jquery2.default)(".task-canvas"));taskObject.R.mergeWith(R);var options={level:null};taskObject.registerSceneGenerator(_MainScene2.default,options);var sceneNames=["loading","main"];taskObject.R.add({parameters:{rate:60,framePerPosition:1,numberOfPoints:5,maxObservationTime:5e3,fixationTime:500,ITI:500,trialsBeforePause:200,pauseTime:6e5,shouldRandomize:"no",feedback:"no",explosion:{explosionTime:500,minSize:.2,maxSize:1.3,minLifeTime:.15,maxLifeTime:.15,emitRate:30,minEmitPower:1,maxEmitPower:2}}}),taskObject.assetsToLoad={crossSheet:{path:"/assets/sprites/cross/squareSheetMargin.svg",type:"texture"},explosionTexture:{path:"/assets/sprites/explosion/particle_explosion.png",type:"texture"}};var parametersNames=["parameters.rate","parameters.framePerPosition","parameters.numberOfPoints","parameters.maxObservationTime","parameters.fixationTime","parameters.ITI","parameters.trialsBeforePause","parameters.pauseTime","parameters.shouldRandomize","parameters.feedback","parameters.explosion.explosionTime","parameters.explosion.minSize","parameters.explosion.maxSize","parameters.explosion.minLifeTime","parameters.explosion.maxLifeTime","parameters.explosion.emitRate","parameters.explosion.minEmitPower","parameters.explosion.maxEmitPower"],parametersConstraints={"parameters.feedback":["yes","no"],"parameters.shouldRandomize":["yes","no"]};taskObject.paramBox.bind(taskObject.R.data,parametersNames,parametersConstraints),window.taskObject=taskObject;var tempMaxNumberOfRetry=taskObject.dataManager.MAX_NUMBER_OF_RETRY,endpoint=window.assetsFolderFullpath+"/api/php/mysql/index.php";taskObject.dataManager.authorize_manual_login=!0,taskObject.dataManager.useLocalStorageCredentials=!1,taskObject.setConnection({endpoint:endpoint,signInForm:loginForm}).then(function(connection){return!!connection.loggedIn||taskObject.dataManager.login(connection)}).then(function(){return taskObject.dataManager.MAX_NUMBER_OF_RETRY=tempMaxNumberOfRetry,taskObject.startTask()}).then(function(message){(0,_experimentJs.debuglog)(message),1!==sceneNames.length&&void 0!==taskObject.paramBox.queryString.currentScene||(taskObject.currentScene="main")}).catch(function(e){(0,_experimentJs.debugError)(e),taskObject.modal({type:"centralLarge",title:R.get.loginError.title.en,content:R.get.loginError.content.en}).then(function(){window.open("","_self").close()})})})},function(module,exports,__webpack_require__){"use strict";"undefined"!=typeof window&&__webpack_require__(5)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.DEBUG_MODE_ON=!1},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function MainScene(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},optionsBase={sceneKey:"main",canvasBackground:new _experimentBabylonJs2.default.Color4(0,0,0,1),backgroundRoundRadius:0,clearColor:new _experimentBabylonJs2.default.Color4(0,0,0,1),canvasPercentWidth:1,canvasPercentHeight:1,mode:"central",level:null};options=_lodash2.default.extend(optionsBase,options);var taskObject=this.taskObject,scene=taskObject.create3DScene(options),light0=new _experimentBabylonJs2.default.HemisphericLight("Hemi0",new _experimentBabylonJs2.default.Vector3(0,1,0),scene);light0.diffuse=new _experimentBabylonJs2.default.Color3(1,1,1),light0.specular=new _experimentBabylonJs2.default.Color3(1,1,1),light0.groundColor=new _experimentBabylonJs2.default.Color3(1,1,1);var stateManager=scene.stateManager,camera=new _experimentBabylonJs2.default.FreeCamera("OrthoCamera",new _experimentBabylonJs2.default.Vector3(-50,0,0),scene);camera.mode=_experimentBabylonJs2.default.Camera.ORTHOGRAPHIC_CAMERA;camera.orthoTop=17,camera.orthoBottom=-17,camera.orthoLeft=-17*taskObject.renderSize.width/taskObject.renderSize.height,camera.orthoRight=17*taskObject.renderSize.width/taskObject.renderSize.height,camera.setTarget(new _experimentBabylonJs2.default.Vector3.Zero),scene.activeCamera=camera;var R=taskObject.R;scene.onResize=[],stateManager.register(_globalFunctions.addButton,_globalFunctions.highlightPosition,_globalFunctions.setBlackScreen,_globalFunctions.checkIdleAndConnection,_globalFunctions.updatePoints,_globalFunctions.placePoints,_globalFunctions.hidePointSpheres,_globalFunctions.showPointSpheres,_globalFunctions.setViewForDirection,_globalFunctions.showCross,_globalFunctions.hideCross,_globalFunctions.explode,_globalFunctions.setLoaderValue,_globalFunctions.hideLoader,_globalFunctions.showLoader,_globalFunctions.setTextLoaderValue),stateManager.call("redrawAssets");var dataManager=this.dataManager,cwDataFields=["subject_id","trial","data_index","direction","position","observation_duration","subject_choice","correct","feedback","response_time","key_hits","clicks","has_paused","start_observation","end_observation","responded_at"];dataManager.addTable("walkerData",cwDataFields),dataManager.addTable("tryoutData",cwDataFields);var userId="unknown"+this.timeInMs;try{userId=dataManager.connections[0].credentials.userId}catch(e){(0,_experimentJs.debugError)(e)}stateManager.set("subject_id",userId);var surveyDataFields=["level","similarTask","taskDifficulty","movementWolf","boredom","dependance","repeatsSequence","comments"];dataManager.addTable("surveyData",surveyDataFields);var eventFields=["id","flag","happenedAt","handledAt","data"];dataManager.addTable("stateRunningEvents",eventFields),dataManager.addTable("stateActiveEvents",eventFields),stateManager.setGlobal("positionData",{indexOnTransitionSequence:-1,indexOnPredictionSequence:-1,fullSequenceIndex:-1}),stateManager.setGlobal("hasSeenLearningInfo",!1),stateManager.setGlobal("hasSeenPredictionInfo",!1),R.add({states:{running:"running",tutorial:"tutorial",tryout:"tryout",tryoutFMRI:"tryoutFMRI",end:"end"},checkpoint:{tutorialDone:["tutorialOneDone","tutorialTwoDone"],levelDone:["levelOneDone","levelTwoDone","levelThreeDone","levelFourDone"],taskDone:"taskDone",taskEndNoComeback:"taskEndNoComeback"},flags:{levelDefined:"levelDefined"},events:{sequenceGenerated:"sequenceGenerated",nextTrial:"nextTrial",goNextPosition:"goNextPosition",endObservation:"endObservation",startPrediction:"startPrediction",responseTimeEnded:"responseTimeEnded",isiAfterLearningEnded:"isiAfterLearningEnded",feedbackEnded:"feedbackEnded",isiAfterFeedbackEnded:"isiAfterFeedbackEnded",pauseTransition:"pauseTransition",forcePause:"forcePause",predictionStartBlackout:"predictionStartBlackout",blackoutEnds:"blackoutEnds",predictionEndsBlackout:"predictionEndsBlackout",isiAfterPredictionEndsBlackout:"isiAfterPredictionEndsBlackout",screenWentBlack:"screenWentBlack",playPredictionSound:"playPredictionSound",playObservationSound:"playObservationSound",showModal:"showModal",goToTutorial:"goToTutorial",hasResponded:"hasResponded",restartTutorial:"restartTutorial",goToLevel1:"goToLevel1",goToLevel2:"goToLevel2",goToLevel3:"goToLevel3",goToLevel4:"goToLevel4",tic:"tic",moreThanFiveNA:"moreThanFiveNA",aknowledgedEnding:"aknowledgedEnding",tutorialNext:"tutorialNext"}});var _stateManager$addStat=stateManager.addState(R.get.states_tutorial,R.get.states_running,R.get.states_tryout,R.get.states_end),_stateManager$addStat2=_slicedToArray(_stateManager$addStat,4),tutorialState=_stateManager$addStat2[0],runningState=_stateManager$addStat2[1],tryoutState=_stateManager$addStat2[2],endState=_stateManager$addStat2[3],pauseState=stateManager.states.pause;if(null!==options.level){var eventData=new _experimentJs.EventData(R.get.flags_levelDefined,scene.stateManager.timeInMs,{belongsTo:["globalLog","stateActiveEvents"],handledAt:null,storedAt:null,level:options.level});stateManager.addEvent(eventData)}else stateManager.states.active.addAwakeningFunctions(_active.selectLevel);stateManager.states.active.addEndingFunctions(_active.endActive),stateManager.states.active.addEventFunctions(R.get.flags_levelDefined,_active.startLevel),stateManager.states.active.addEventFunctions(R.get.events_goToTutorial,function(_ref){var tutorial=_ref.data.tutorial;stateManager.setGlobal("currentTutorial",tutorial),stateManager.goToState(R.get.states_tutorial)});var goToPause=function(){this.state.shouldPause&&(this.state.freeze(),(0,_experimentJs.hasConstructor)(Object,this.taskObject.currentModal)&&(0,_experimentJs.hasConstructor)(_experimentBoxes.SmartModal,this.taskObject.currentModal.modalBox)&&this.taskObject.currentModal.modalBox.hide(),this.stateManager.goToState(this.R.get.states_pause))};return runningState.addAwakeningFunctions(_running.startRunning),runningState.addEventFunctions(R.get.events_nextTrial,_running.nextTrial),runningState.addEventFunctions(R.get.events_goNextPosition,_running.goToNextPosition),runningState.addEventFunctions(R.get.events_endObservation,_running.endObservation),runningState.addEventFunctions(R.get.events_startPrediction,_running.startPrediction),runningState.addEventFunctions(R.get.events_pauseTransition,_running.pauseTransition),runningState.addEventFunctions(R.get.events_unfrozen,_running.stateUnfrozen),runningState.addEventFunctions(R.get.events_forcePause,goToPause),runningState.addEventFunctions(R.get.events_windowBlur,goToPause),runningState.addEventFunctions(R.get.events_moreThanFiveNA,goToPause),runningState.addEventFunctions(R.get.events_click,_running.checkForClickPrediction),runningState.addEventFunctions(R.get.events_keydown,_running.checkKeyStrokeForPrediction),runningState.addEventFunctions(R.get.events_playPredictionSound,_running.playSound),runningState.addEventFunctions(R.get.events_playObservationSound,_running.playSound),tutorialState.addAwakeningFunctions(_tutorial.awakeTutorial),tutorialState.addEventFunctions(R.get.events_tutorialNext,_tutorial.showNextPage),tutorialState.addEventFunctions(R.get.events_showModal,_tutorial.showModal),tutorialState.addEventFunctions(R.get.events_windowBlur,goToPause),tutorialState.addEventFunctions(R.get.events_unfrozen,_tutorial.tutorialUnfrozen),tutorialState.addEventFunctions(R.get.events_playPredictionSound,_running.playSound),tutorialState.addEventFunctions(R.get.events_playObservationSound,_running.playSound),dataManager.addTable("stateTryout1",eventFields),dataManager.addTable("stateTryout2",eventFields),tryoutState.addAwakeningFunctions(_tryout.awakeTryout),tryoutState.addEndingFunctions(_tryout.tryoutEnd),tryoutState.addEventFunctions(R.get.events_goNextPosition,_tryout.tryoutGoToNextPosition),tryoutState.addEventFunctions(R.get.events_endObservation,_running.endObservation),tryoutState.addEventFunctions(R.get.events_windowBlur,goToPause),tryoutState.addEventFunctions(R.get.events_unfrozen,_tutorial.tutorialUnfrozen),tryoutState.addEventFunctions(R.get.events_startPrediction,_tryout.tryoutStartPrediction),tryoutState.addEventFunctions(R.get.events_responseTimeEnded,_tryout.tryoutEndPrediction),tryoutState.addEventFunctions(R.get.flags_levelDefined,_active.startLevel),tryoutState.addEventFunctions(R.get.events_restartTutorial,function(){stateManager.goToState(R.get.states_tutorial)}),tryoutState.addEventFunctions(R.get.events_keydown,_tryout.tryoutCheckKeyStrokeForPrediction),tryoutState.addEventFunctions(R.get.events_click,_running.checkForClickPrediction),pauseState.addAwakeningFunctions(_pause.awakenPause),pauseState.addEndingFunctions(_pause.endPause),pauseState.addEventFunctions(R.get.events_keydown,_pause.pauseKeyDown),pauseState.addEventFunctions(R.get.events_windowFocus,_pause.pauseKeyDown),endState.addAwakeningFunctions(_end.awakenEnd),scene}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(_experimentJs.Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();exports.default=MainScene;var _lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_experimentBoxes=__webpack_require__(3),_globalFunctions=__webpack_require__(4),_active=__webpack_require__(9),_tutorial=__webpack_require__(14),_tryout=__webpack_require__(13),_running=__webpack_require__(12),_pause=__webpack_require__(11),_end=__webpack_require__(10)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.endActive=exports.selectLevel=exports.startLevel=void 0;var _experimentJs=__webpack_require__(0),selectLevel=function(){var _this=this;if(void 0===this.state)throw new Error("state.selectLevel: state is undefined");var stateManager=this.stateManager,dataManager=this.dataManager,elements2D=stateManager.get("elements2D"),R=this.R,checkTaskDone=dataManager.query("hasCheckpoint",{checkpoint:R.get.checkpoint_taskDone},this.connection),checkTaskEndNoComeback=dataManager.query("hasCheckpoint",{checkpoint:R.get.checkpoint_taskEndNoComeback},this.connection),checkTutorialOne=dataManager.query("hasCheckpoint",{checkpoint:R.get.checkpoint_tutorialDone[0]},this.connection);stateManager.call("hideAll"),stateManager.set("shouldCheckTime",!1);var taskEnded=!1,deferred=new _experimentJs.Deferred;return Promise.all([checkTaskDone,checkTaskEndNoComeback,checkTutorialOne]).then(function(results){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=results[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var result=_step.value;if(void 0===result.code)stateManager.currentStateKey!==R.get.states_idle&&stateManager.goToState(R.get.states_idle),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:"active"})});else{if(result.code===R.get.checkpoint_taskDone||result.code===R.get.checkpoint_taskEndNoComeback)return taskEnded=!0,stateManager.set("endReason",result.message),stateManager.goToState(R.get.states_end),deferred.resolve("active.selectLevel: end of task"),!1;result.code!==R.get.checkpoint_tutorialDone[0]||taskEnded||stateManager.set("shouldCheckTime",!0)}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return _this.dataManager.query("getCheckpoint",null,_this.connection)}).then(function(result){if(!1!==result){void 0===result.code&&(stateManager.currentStateKey!==R.get.states_active&&stateManager.goToState(R.get.states_idle),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:"active"})}));var eventLevel=void 0;switch(result.code){case R.get.checkpoint_tutorialDone[0]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:1}),elements2D.wolfFaceSprite.spriteFrame=0;break;case R.get.checkpoint_tutorialDone[1]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:4}),elements2D.wolfFaceSprite.spriteFrame=3;break;case R.get.checkpoint_levelDone[0]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:2}),elements2D.wolfFaceSprite.spriteFrame=1;break;case R.get.checkpoint_levelDone[1]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:3}),elements2D.wolfFaceSprite.spriteFrame=2;break;case R.get.checkpoint_levelDone[2]:eventLevel=new _experimentJs.EventData(R.get.events_goToTutorial,stateManager.timeInMs,{tutorial:2}),elements2D.wolfFaceSprite.spriteFrame=3;break;case R.get.checkpoint_levelDone[3]:stateManager.set("endReason","You finished the task finished"),stateManager.goToState(R.get.states_end);break;case R.get.checkpoint_taskDone:case R.get.checkpoint_taskEndNoComeback:stateManager.set("endReason",result.message),stateManager.goToState(R.get.states_end);break;default:eventLevel=new _experimentJs.EventData(R.get.events_goToTutorial,stateManager.timeInMs,{tutorial:1})}(0,_experimentJs.delay)(150).then(function(){stateManager.addEvent(eventLevel)}),deferred.resolve("active.selectLevel: level selected - resolved")}}).catch(function(){stateManager.currentStateKey!==R.get.states_active&&stateManager.goToState(R.get.states_idle),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:"active"})})}),deferred.promise},startLevel=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.taskObject)throw new Error("state.startLevel: this.taskObject is undefined");if(void 0===options.data.level)throw new Error("state.startLevel: options.level is undefined");var taskObject=this.taskObject,stateManager=this.stateManager,R=this.R,elements2D=stateManager.get("elements2D");return stateManager.emptyTimeTriggerEvents(),elements2D.agent.opacity=0,elements2D.cross.spriteFrame=R.get.cross_base,stateManager.promise("disposeOfButtons"),stateManager.setGlobal("level",options.data.level),stateManager.setGlobal("levelObject",taskObject.parameters.levels[options.data.level-1]),stateManager.set("positionData",{indexOnTransitionSequence:-1,indexOnPredictionSequence:-1,fullSequenceIndex:taskObject.parameters.levels[options.data.level-1].sequenceObject.fullSequence.length-3}),stateManager.currentStateKey!==R.get.states_running&&stateManager.goToState(R.get.states_running),"state.startLevel: resolved"},endActive=function(){};exports.startLevel=startLevel,exports.selectLevel=selectLevel,exports.endActive=endActive},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.awakenEnd=void 0;var _experimentJs=__webpack_require__(0),awakenEnd=function(){var _this=this,R=this.R,scene=this.scene;this.stateManager.call("hideAll"),scene.initialGui.levelVisible=!1,this.dataManager.authorize_manual_login=!1,this.dataManager.query("hasCheckpoint",{checkpoint:R.get.checkpoint_taskDone},this.connection).then(function(r){var event=new _experimentJs.EventData(_this.R.get.events_aknowledgedEnding);_this.stateManager.onNext(_this.R.get.events_aknowledgedEnding,function(){window.open("","_self").close()});var reason="You completed the task !",title=R.get.taskFinishedTitle,content=R.get.taskFinishedContent;r.code!==R.get.checkpoint_taskDone?(reason=_this.stateManager.get("endReason",""),title=R.get.taskStoppedTitle,content=R.get.taskStoppedMessage,""!==reason&&(content+=R.get.taskStoppedReason.replace("{t}",reason)),_this.taskObject.setCheckpoint(R.get.checkpoint_taskEndNoComeback,reason),_this.taskObject.modal({type:"centralLarge",title:title,content:content,event:event})):_this.taskObject.modal({type:"centralLarge",title:title,content:content,event:event})})};exports.awakenEnd=awakenEnd},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pauseKeyDown=exports.endPause=exports.awakenPause=void 0;var _experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_globalFunctions=__webpack_require__(4),awakenPause=function(){var stateManager=this.stateManager,levelObject=stateManager.get("levelObject"),GUI=stateManager.get("GUI"),R=this.R,state=this.state,pauseTime=stateManager.timeInMs,threshold=R.get.thresholdIdle;state.hitKeyTime=null,state.initialGuiVisible=GUI.levelVisible,GUI.backgroundFill=_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(0,0,0,1)),GUI.levelVisible=!0,stateManager.get("lastPauseInfo",{level:levelObject.level,time:pauseTime}).level!==levelObject.level&&stateManager.set("pauseTimeLeft",threshold);var currentTimeLeft=stateManager.get("pauseTimeLeft",threshold);stateManager.set("lastPauseInfo",{level:levelObject.level,time:pauseTime});var options={id:"pauseText",parent:GUI,marginAlignment:"h: center, v: center",fontName:"30pt Arial",fontSignedDistanceField:!0};state.timerText=function(){var timeLeft=parseInt((currentTimeLeft-stateManager.timeInMs+pauseTime)/1e3,10);return!(timeLeft<0)&&R.get.timeLimitText.replace("{n}",(0,_experimentJs.String)(timeLeft))};var t=0;state.tic=function(){state.centerText.levelVisible=!0;var text=state.timerText();!1===text?(stateManager.set("endReason",R.get.endReasonIdle.replace("{t}",threshold/1e3).replace("{l}",levelObject.level)),stateManager.goToState(R.get.states_end)):(state.centerText.text=text,(0,_experimentJs.delay)(200).then(function(){stateManager.currentStateKey===R.get.states_pause&&state.tic()}),(t+=200)>=3e3&&(stateManager.get("sounds").prediction.play(),t=0))},(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Text2D,state.centerText)?(state.topText.levelVisible=!0,state.centerText.levelVisible=!0,state.centerText.text=state.timerText):(state.topText=new _experimentBabylonJs2.default.Text2D(R.get.pauseText,options),(0,_globalFunctions.setMargins)(state.topText,{topPixels:0,bottomPixels:40,leftPixels:0,rightPixels:0}),state.centerText=new _experimentBabylonJs2.default.Text2D(state.timerText(),options)),(0,_experimentJs.delay)(200).then(function(){stateManager.currentStateKey===R.get.states_pause&&state.tic()})},pauseKeyDown=function(){var state=this.state,stateManager=this.stateManager,levelObject={level:0},R=this.R,context=this,threshold=R.get.thresholdIdle;null===state.hitKeyTime&&(state.hitKeyTime=stateManager.timeInMs),state.timerText=function(){var timeLeft=Math.ceil((3e3-stateManager.timeInMs+state.hitKeyTime)/1e3,10);return!(timeLeft<0)&&R.get.pauseRestart.replace("{n}",(0,_experimentJs.String)(timeLeft))},state.tic=function(){var text=state.timerText();!1!==text?(state.centerText.text=text,(0,_experimentJs.delay)(200).then(function(){if(document.hasFocus())stateManager.currentStateKey===R.get.states_pause&&state.tic();else{var lastPauseInfo=stateManager.get("lastPauseInfo",{level:levelObject.level,time:stateManager.timeInMs}),previousTimeLeft=stateManager.get("pauseTimeLeft",threshold),currentTimeLeft=previousTimeLeft-stateManager.timeInMs+lastPauseInfo.time;stateManager.set("pauseTimeLeft",currentTimeLeft),awakenPause.bind(context)()}})):stateManager.frozenState&&stateManager.goToState(stateManager.frozenState)},(0,_experimentJs.delay)(200).then(function(){document.hasFocus()?stateManager.currentStateKey===R.get.states_pause&&state.tic():awakenPause.bind(context)()})},endPause=function(){var stateManager=this.stateManager,state=this.state,levelObject={level:0},GUI=stateManager.get("GUI"),R=this.R,threshold=R.get.thresholdIdle;GUI.backgroundFill=_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(1,1,1,0)),GUI.levelVisible=state.initialGuiVisible,state.hitKeyTime=null,state.topText.levelVisible=!1,state.centerText.levelVisible=!1;var lastPauseInfo=stateManager.get("lastPauseInfo",{level:levelObject.level,time:stateManager.timeInMs}),previousTimeLeft=stateManager.get("pauseTimeLeft",threshold),currentTimeLeft=previousTimeLeft-stateManager.timeInMs+lastPauseInfo.time;currentTimeLeft<-3?stateManager.call("prematureEnd",{reason:R.get.prematureEndPauseAboveThreshold}):stateManager.set("pauseTimeLeft",currentTimeLeft)};exports.awakenPause=awakenPause,exports.endPause=endPause,exports.pauseKeyDown=pauseKeyDown},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.pauseTransition=exports.endObservation=exports.playSound=exports.checkKeyStrokeForPrediction=exports.checkForClickPrediction=exports.startPrediction=exports.goToNextPosition=exports.nextTrial=exports.startRunning=exports.stateUnfrozen=void 0;var _lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),stateUnfrozen=function(){_lodash2.default.has(this.state,"currentTrialData.hasPaused")&&(this.state.currentTrialData.hasPaused=!0)},pauseTransition=function(){var stateManager=this.stateManager,state=this.state,R=this.R,parameters=this.R.get.parameters,trials=this.R.get.trials,index=stateManager.get("currentTrial",0),pausesDone=stateManager.get("pausesDone",0);try{if(index+1>=trials.length)return this.taskObject.setCheckpoint(R.get.checkpoint_taskDone).promise.then(function(){stateManager.goToState(R.get.states_end)});var maxTransitionTime=parameters.pauseTime+stateManager.timeInMs,promise=stateManager.resolveOnKey({except:null}),shouldtic=!0,text2d=void 0,transitionText=function(){var timeLeft=Math.ceil((maxTransitionTime-stateManager.timeInMs)/1e3,10);return!(timeLeft<0)&&R.get.finishedLevelTransition.replace("{n}",(0,_experimentJs.String)(timeLeft)).replace("{l}",(0,_experimentJs.String)(pausesDone.length))};state.tic=function(){if(shouldtic){var text=transitionText();!1!==text?(text2d.text=text,state.tooltipPause.box.levelVisible=!0,(0,_experimentJs.delay)(200).then(function(){state.tooltipPause.box.levelVisible=!1,state.tic()})):(stateManager.set("endReason","You were idle for more than 15 min"),stateManager.goToState(R.get.states_end))}};var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5);return state.tooltipPause=stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,this.taskObject.renderSize.height/2-100)),text:transitionText(),duration:promise}),text2d=state.tooltipPause.text,this.state.shouldPause=!1,state.tic(),promise.then(function(){shouldtic=!1,stateManager.newEvent(R.get.events_nextTrial,null,null,["stateRunningEvents"])})}catch(e){return(0,_experimentJs.debugError)("running.pauseTransition: error with the level data."),stateManager.set("endReason","There was an error with the task. We are sorry."),stateManager.goToState(R.get.states_end),"Running.pauseTransition: Error"}},startRunning=function(){var _this=this;if(void 0===this.taskObject)throw new Error("state.startRunning: this.taskObject is undefined");var stateManager=this.stateManager,state=this.state,R=stateManager.R,parameters=R.get.parameters;R.get.trials=R.get.trials.slice(1,20),document.hasFocus()||stateManager.newEvent(R.get.forcePause),state.shouldPause=!1,state.pausedBetween=[],stateManager.call("showAll"),stateManager.call("setLoaderValue",0),null===stateManager.get("trialIndices")&&("yes"===parameters.shouldRandomize?stateManager.set("trialIndices",(0,_experimentJs.samplePermutation)((0,_experimentJs.rep)(0,R.get.trials.length).map(function(o,i){return i}))):stateManager.set("trialIndices",(0,_experimentJs.rep)(0,R.get.trials.length).map(function(o,i){return i}))),void 0===state.data&&(state.data=[]),state.numberOfMissed=0,state.isPredicting=!1;var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5),promise=stateManager.resolveOnKey({except:null});return stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,this.taskObject.renderSize.height/2-100)),text:"You are about to start the task\nHit a key to when ready",duration:promise}),promise.then(function(){var nextTransitionTime=_this.stateManager.timeInMs+100,nextTransitionEvent=new _experimentJs.EventData(R.get.events_nextTrial,nextTransitionTime,{belongsTo:["globalLog","stateRunningEvents"],handledAt:null,storedAt:null});stateManager.addTimeTriggerEvent(nextTransitionEvent)}),"state.startRunning: resolved"},storeData=function(){var state=this.state,stateManager=this.stateManager,dataToStore=state.currentTrialData;try{if((0,_experimentJs.hasConstructor)(Object,state.currentTrialData)&&stateManager.get("subject_id")){var _state$currentTrialDa=state.currentTrialData,trial=_state$currentTrialDa.trial,dataIndex=_state$currentTrialDa.dataIndex,direction=_state$currentTrialDa.direction,choice=_state$currentTrialDa.choice,feedback=_state$currentTrialDa.feedback,responseTime=_state$currentTrialDa.responseTime,startObservation=_state$currentTrialDa.startObservation,_endObservation=_state$currentTrialDa.endObservation,respondedAt=_state$currentTrialDa.respondedAt,keysHits=_state$currentTrialDa.keysHits,hasPaused=_state$currentTrialDa.hasPaused,clicks=_state$currentTrialDa.clicks,correct=direction===choice;dataToStore={subject_id:stateManager.get("subject_id"),trial:trial,data_index:dataIndex,direction:direction,observation_duration:_endObservation-startObservation,subject_choice:choice,response_time:responseTime,correct:correct,feedback:feedback,key_hits:JSON.stringify(keysHits),clicks:JSON.stringify(clicks),has_paused:hasPaused,start_observation:startObservation,end_observation:_endObservation,responded_at:respondedAt,belongsTo:["walkerData"]},stateManager.storeData(dataToStore),state.currentTrialData=null}}catch(e){var message="runningState.goToNextPosition: could not store cwData.";(0,_experimentJs.debugError)(message),stateManager.storeInErrorLog({message:message,timestamp:stateManager.timeInMs,data:dataToStore})}},nextTrial=function(){var _this2=this,parameters=this.R.get.parameters;"yes"===parameters.feedback&&(0,_experimentJs.hasConstructor)(Object,this.state.currentTrialData)&&this.state.currentTrialData.direction===this.state.currentTrialData.choice&&this.stateManager.call("explode",{meshes:this.stateManager.get("pointSpheres",[])}),this.state.isPredicting=!1,this.stateManager.call("hidePointSpheres"),storeData.bind(this)();var trials=this.R.get.trials,trialIndices=this.stateManager.get("trialIndices",(0,_experimentJs.rep)(0,this.R.get.trials.length).map(function(o,i){return i})),pausesDone=this.stateManager.get("pausesDone",[]),trialIndex=this.stateManager.get("currentTrial",-1)+1;if(trialIndex>=trials.length||Math.floor(trialIndex/parameters.trialsBeforePause)>pausesDone.length)return this.stateManager.set("pausesDone",pausesDone.concat(pausesDone.length)),this.stateManager.newEvent(this.R.get.events_pauseTransition,null,null,["globalLog","stateRunningEvents"]),"End trials";this.stateManager.call("setLoaderValue",Math.floor(100*trialIndex/trials.length)),this.stateManager.call("setTextLoaderValue",trialIndex),this.stateManager.set("currentTrial",trialIndex),this.stateManager.set("currentDataTrialIndex",trialIndices[trialIndex]);var trialData=trials[trialIndices[trialIndex]],data={trial:trialIndex,dataIndex:trialIndices[trialIndex],direction:trialData.direction,positions:trialData.positions,feedback:parameters.feedback,currentIndex:-1,state:this.state.stateKey,choice:null,responseTime:null,startObservation:null,endObservation:null,respondedAt:null,keysHits:[],clicks:[],hasPaused:!1};if(this.state.data.push(data),this.state.currentTrialData=data,(0,_experimentJs.delay)(parameters.explosion.explosionTime).then(function(){_this2.stateManager.call("setViewForDirection",data),_this2.stateManager.call("showCross")}),21===trialIndex){var tutorial=this.R.get.tutorials_getHarder,event=new _experimentJs.EventData(this.R.get.events_goNextPosition);this.taskObject.modal({type:"centralLarge",title:tutorial.title.en,content:tutorial.content.en,event:event}),this.taskObject.currentModal.modalBox.buttonText="Next"}else this.stateManager.newEvent(this.R.get.events_goNextPosition,parameters.ITI+parameters.explosion.explosionTime,null,["stateRunningEvents"]);return"End nextTrial"},goToNextPosition=function(){if("undefined"===this.state.currentTrialData)return"State.Running.goToNextPosition: undefined current trial data";var stateManager=this.stateManager,state=this.state,R=stateManager.R,parameters=R.get.parameters;stateManager.call("hideCross");var trialData=state.currentTrialData;document.hasFocus()||stateManager.newEvent(R.get.events_windowBlur,null,null,["stateRunningEvents"]);var checkConnection=!1;if((0,_experimentJs.hasConstructor)(_experimentJs.Deferred,this.state.checkLastInteraction)?this.state.checkLastInteraction.pending||(this.state.checkLastInteraction=new _experimentJs.Deferred,checkConnection=!0):(this.state.checkLastInteraction=new _experimentJs.Deferred,checkConnection=!0),checkConnection&&stateManager.call("checkIdleAndConnection",{deferred:this.state.checkLastInteraction}),null===trialData.startObservation&&(trialData.startObservation=stateManager.timeInMs),stateManager.timeInMs-trialData.startObservation>parameters.maxObservationTime||null!==trialData.choice)return trialData.endObservation=stateManager.timeInMs,stateManager.newEvent(R.get.events_nextTrial,null,null,["stateRunningEvents"]),"End observation";this.stateManager.call("showPointSpheres"),state.isPredicting=!0;var positions=trialData.positions;trialData.currentIndex+parameters.framePerPosition>=positions.length&&(trialData.currentIndex=-1),trialData.currentIndex+=parameters.framePerPosition;var index=trialData.currentIndex;if(index>=positions.length){var nextTransitionEvent=new _experimentJs.EventData(R.get.events_pauseTransition,stateManager.timeInMs,{belongsTo:["globalLog","stateRunningEvents"],handledAt:null,storedAt:null});return stateManager.addTimeTriggerEvent(nextTransitionEvent),"goToNextPosition: resolved. End of sequence."}var deferred=new _experimentJs.Deferred,points=positions[index],rate=parameters.rate;return stateManager.promise("updatePoints",points).then(function(){stateManager.newEvent(R.get.events_goNextPosition,1e3/rate,null,["stateRunningEvents"]),state.numberOfMissed>=5&&(stateManager.newEvent(R.get.events_moreThanFiveNA,null,null,["stateRunningEvents"]),deferred.resolve("goToNextPosition: resolved. Too many NA.")),deferred.resolve("stateManager.goToNextPosition: resolved")}),deferred.promise},endObservation=function(){return this.state.currentTrialData.endObservation=this.stateManager.timeInMs,this.stateManager.call("setAgentOpacity",{opacity:0}),"endObservation resolved"},startPrediction=function(){if(void 0===this.state.currentTrialData)throw new Error("state.startPrediction: state.currentTrialData is undefined");var state=this.state,stateManager=this.stateManager,R=stateManager.R;state.numberOfMissed+=1;var levelObject=stateManager.get("levelObject");stateManager.promise("setAgentOpacity",{opacity:R.get.agent_predictionOpacity}),stateManager.call("drawPredictionTiles"),this.stateManager.get("elements2D").cross.spriteFrame=R.get.cross_predict,!0===levelObject.sound&&this.stateManager.get("sounds").prediction.play(),state.isPredicting=!0,state.currentTrialData.startPrediction=stateManager.timeInMs;var endResponse=levelObject.predictionDuration;this.stateManager.newEvent(R.get.events_responseTimeEnded,endResponse,null,["stateRunningEvents"])},checkForClickPrediction=function(){var event=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();try{if(void 0===this.taskObject)throw new Error("state.checkForClickPrediction: this.taskObject is undefined");if(void 0===event.data.clientY)throw new Error("state.checkForClickPrediction: event.data.clientY is undefined.");if(void 0===this.state.currentTrialData)throw new Error("state.checkForClickPrediction: options.trialData is undefined");var stateManager=this.stateManager;this.state.currentTrialData.clicks.push([event.data.engineX,event.data.engineY,stateManager.timeInMs])}catch(e){(0,_experimentJs.debugError)(e)}return"checkForClickPrediction resolved"},checkKeyStrokeForPrediction=function(){var event=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();try{if(void 0===this.taskObject)throw new Error("state.checkKeyStrokeForPrediction: this.taskObject is undefined");if(void 0===event.data.keyCode)throw new Error("state.startPrediction: event.data.keyCode is undefined");if(void 0===this.state.currentTrialData)throw new Error("state.startPrediction: state.currentTrialData is undefined");var stateManager=this.stateManager,state=this.state,R=this.R,keyCode=event.data.keyCode,keyValue=event.data.key;_lodash2.default.has(state,"currentTrialData.keysHits")&&((0,_experimentJs.hasConstructor)(_experimentJs.Array,state.currentTrialData.keysHits)||(state.currentTrialData.keysHits=[]),state.currentTrialData.keysHits.push([keyValue,keyCode,stateManager.timeInMs]));var keys={ArrowLeft:[39,"LEFT",R.get.cross_bottomRight],ArrowRight:[37,"RIGHT",R.get.cross_topLeft]},direction=null;for(var key in keys)if(keys.hasOwnProperty(key)){var keyPosition=keys[key];keyValue===key&&(direction=keyPosition[1])}return null!==direction?!0===state.isPredicting&&null===state.currentTrialData.choice?(state.currentTrialData.choice=direction,state.currentTrialData.responseTime=stateManager.timeInMs-state.currentTrialData.startObservation,state.currentTrialData.respondedAt=stateManager.timeInMs,state.numberOfMissed=0,(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: has chosen direction "+direction+"."),direction):((0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: already chosen"),!1):((0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: key did not correspond to state selection keys."),!1)}catch(e){return(0,_experimentJs.debugError)(e),!1}},playSound=function(event){this.stateManager.getGlobal("sounds")[event.data.name].play()};exports.stateUnfrozen=stateUnfrozen,exports.startRunning=startRunning,exports.nextTrial=nextTrial,exports.goToNextPosition=goToNextPosition,exports.startPrediction=startPrediction,exports.checkForClickPrediction=checkForClickPrediction,exports.checkKeyStrokeForPrediction=checkKeyStrokeForPrediction,exports.playSound=playSound,exports.endObservation=endObservation,exports.pauseTransition=pauseTransition},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.tryoutEnd=exports.tryoutStartPrediction=exports.tryoutGoToNextPosition=exports.tryoutCheckKeyStrokeForPrediction=exports.tryoutEndPrediction=exports.awakeTryout=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_taskUtilities=__webpack_require__(15),awakeTryout=function(){var taskObject=this.taskObject,state=this.state,currentTutorial=this.stateManager.get("currentTutorial",1),stateManager=this.stateManager,elements2D=stateManager.get("elements2D");this.R;elements2D.loader.value=0,stateManager.call("showAll"),state.data=state.data||[],state.isPredicting=!1,state.shouldPause=1!==currentTutorial,state.index=-1,stateManager.setGlobal("level","tryout-"+currentTutorial),1===currentTutorial?(state.sequenceObject=(0,_taskUtilities.getFullSequenceObjectForClassicLevels)([1,3,4,2,1,3,4,2,1,3,2,4,2,1,3]),stateManager.setGlobal("levelObject",this.taskObject.parameters.levels[0])):(state.sequenceObject={fullSequence:[1,2,1,3,4,2,1,3,4,3],trial:_lodash2.default.range(1,10),trialType:(0,_experimentJs.rep)(["observation_prediction","blackout"],5),block:(0,_experimentJs.rep)(1,5).concat((0,_experimentJs.rep)(2,5)),blockType:(0,_experimentJs.rep)("random",5).concat((0,_experimentJs.rep)("normal",5))},stateManager.setGlobal("levelObject",taskObject.parameters.levels[3])),this.stateManager.newEvent(this.R.get.events_goNextPosition,null,null,["stateTryout"+currentTutorial])},tryoutGoToNextPosition=function(){var _this=this,stateManager=this.stateManager,state=this.state;state.index+=1;var elements2D=stateManager.get("elements2D"),levelObject=stateManager.get("levelObject"),cross=elements2D.cross,R=this.R,tutorials=R.get.tutorials,currentTutorial=stateManager.get("currentTutorial",1),index=state.index,sequenceObject=state.sequenceObject;stateManager.hideTooltip(),state.isWaitingToPredict=new _experimentJs.Deferred,state.isWaitingToPredict.resolve();var ntransition=sequenceObject.fullSequence.length;if(index>ntransition-1){if(stateManager.call("hideAll"),1===currentTutorial){var event=new _experimentJs.EventData(this.R.get.flags_levelDefined,stateManager.timeInMs,{level:1});this.taskObject.modal({title:tutorials.askContinue.title.en,content:tutorials.askContinue.content.en,event:event})}else{var _event=new _experimentJs.EventData(this.R.get.flags_levelDefined,stateManager.timeInMs,{level:4});this.taskObject.modal({title:tutorials.askfMRIContinue.title.en,content:tutorials.askfMRIContinue.content.en,event:_event})}return this.taskObject.currentModal.modalBox.buttonText="Go !","state.tryoutGoToNextPosition: finished tryout"}elements2D.loader.value=100*index/ntransition;var lastChoice=null;"object"===_typeof(state.currentTrialData)&&"number"==typeof state.currentTrialData.choice&&(lastChoice=parseInt(state.currentTrialData.choice,10));var trialData={level:levelObject.level,fullSequenceIndex:index,block:sequenceObject.block[index],blockType:sequenceObject.blockType[index],trial:sequenceObject.trial[index],trialType:sequenceObject.trialType[index],state:state.stateKey,position:sequenceObject.fullSequence[index],choice:null,responseTime:null,startObservation:null,endObservation:null,respondedAt:null,startPrediction:null,endPrediction:null,nextPosition:null,observedTransitionWasDominant:null,keysHits:[],clicks:[],hasPaused:null};state.data.push(trialData);var dataToStore=state.currentTrialData;try{if(void 0!==state.currentTrialData&&stateManager.get("subject_id")){var _state$currentTrialDa=state.currentTrialData,block=_state$currentTrialDa.block,blockType=_state$currentTrialDa.blockType,trial=_state$currentTrialDa.trial,trialType=_state$currentTrialDa.trialType,position=_state$currentTrialDa.position,choice=_state$currentTrialDa.choice,responseTime=_state$currentTrialDa.responseTime,startObservation=_state$currentTrialDa.startObservation,startPrediction=_state$currentTrialDa.startPrediction,respondedAt=_state$currentTrialDa.respondedAt,endPrediction=_state$currentTrialDa.endPrediction,keysHits=_state$currentTrialDa.keysHits,hasPaused=_state$currentTrialDa.hasPaused,clicks=_state$currentTrialDa.clicks,endObservation=_state$currentTrialDa.endObservation;dataToStore={subject_id:stateManager.get("subject_id"),level:currentTutorial,block:block,block_type:blockType,dominant_structure:levelObject.dominantStructure,dominant_transition_probability:levelObject.dominantProbability,trial:trial,trial_type:trialType,position:position,observation_duration:startPrediction?startPrediction-startObservation:this.timeInMs-startObservation,observed_transition_was_dominant:null,transition_to:sequenceObject.fullSequence[index],subject_choice:choice,response_time:responseTime,correct:parseInt(sequenceObject.fullSequence[index],10)===parseInt(choice,10),key_hits:JSON.stringify(keysHits),clicks:JSON.stringify(clicks),has_paused:hasPaused,start_observation:startObservation,end_observation:endObservation,start_prediction:startPrediction,responded_at:respondedAt,end_prediction:endPrediction,belongsTo:["tryoutData"]},stateManager.storeData(dataToStore)}}catch(e){var message="runningState.goToNextPosition: could not store cwData.";(0,_experimentJs.debugError)(message),stateManager.storeInErrorLog({message:message,timestamp:stateManager.timeInMs,data:dataToStore})}state.currentTrialData=trialData,state.isPredicting=!1;var agentType="wolf";"random"===sequenceObject.blockType[index]&&(agentType="rabbit"),elements2D.agentType!==agentType&&stateManager.call("setAgent",{agent:agentType}),cross.spriteFrame=this.R.get.cross_base,stateManager.call("drawTiles",{withKeys:!1}),stateManager.call("moveAgentToTile",{tile:trialData.position-1,opacity:1});var promise=Promise.resolve();return 1!==currentTutorial||R.get.wolfFirstAppears.passed?2!==currentTutorial||R.get.rabbitFirstAppear.passed?2!==currentTutorial||"blackout"!==sequenceObject.trialType[index-1]||R.get.blackoutFirstAppear.passed?2!==currentTutorial||"normal"!==sequenceObject.blockType[index]||R.get.wolfFmriFirstAppear.passed||(promise=this.taskObject.modal({title:R.get.wolfFmriFirstAppear_title,content:R.get.wolfFmriFirstAppear_message}),R.get.wolfFmriFirstAppear.passed=!0):(promise=this.taskObject.modal({title:R.get.blackoutFirstAppear_title,content:R.get.blackoutFirstAppear_message}),R.get.blackoutFirstAppear.passed=!0):(promise=this.taskObject.modal({title:R.get.rabbitFirstAppear_title,content:R.get.rabbitFirstAppear_message}),R.get.rabbitFirstAppear.passed=!0):(promise=this.taskObject.modal({title:R.get.wolfFirstAppears_title,content:R.get.wolfFirstAppears_message}),R.get.wolfFirstAppears.passed=!0),promise.then(function(){trialData.startObservation=stateManager.timeInMs;var promise=Promise.resolve(),centerPosition=(0,_experimentJs.sizeToVec)(_this.taskObject.renderSize).scale(.5);if(0!==index&&"blackout"!==sequenceObject.trialType[index-1]&&sequenceObject.blockType[index-1]===sequenceObject.blockType[index])if(lastChoice===sequenceObject.fullSequence[index]){var background=new _experimentBabylonJs2.default.Color4(.1,.7,.1,.9),text="Correct!",duration=2e3;1!==currentTutorial||R.get.predictionTest.passed||(text+="\nHit a key to continue",promise=stateManager.resolveOnKey({except:null}),duration=promise);var _position=centerPosition,tilePosition=stateManager.call("getTilePositions")[lastChoice-1];_position=tilePosition,stateManager.tooltip({position:_position,background:background,text:text,duration:duration})}else{var _background=new _experimentBabylonJs2.default.Color4(.7,.1,.1,.9),_position2=centerPosition;if((0,_experimentJs.hasConstructor)(Number,lastChoice)){var _tilePosition=stateManager.call("getTilePositions")[lastChoice-1];_position2=_tilePosition}var _text="Incorrect!",_duration=2e3;1!==currentTutorial||R.get.predictionTest.passed||(_text+="\nHit a key to continue",promise=stateManager.resolveOnKey({except:null}),_duration=promise),stateManager.tooltip({position:_position2,background:_background,text:_text,duration:_duration})}return 1===currentTutorial&&!R.get.predictionTest.passed&&R.get.predictionTest.numberOfPrediction>=3?(R.get.predictionTest.passed=!0,promise=stateManager.resolveOnKey({except:null}),stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,centerPosition.y-100)),text:R.get.realTimeTest_message+"\nHit a key to continue",duration:promise})):R.get.predictionTest.passed&&(0,_experimentJs.delay)(1e3).then(function(){state.isWaitingToPredict=new _experimentJs.Deferred}),promise}).then(function(){if(trialData.startObservation=stateManager.timeInMs,stateManager.newEvent(R.get.events_endObservation,levelObject.observationDuration,null,["stateRunningEventsLvl"+levelObject.level]),1===currentTutorial){var nextTransitionTime=trialData.startObservation+levelObject.observationDuration+_lodash2.default.random(levelObject.minISIAfterLearning,levelObject.maxISIAfterLearning);stateManager.newEvent(_this.R.get.events_startPrediction,nextTransitionTime,null,["stateTryout"+currentTutorial])}else if("blackout"===sequenceObject.trialType[index]){var observationTime=levelObject.observationDuration+levelObject.fixedISIAfterObservation+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterObservation,0,levelObject.maxSampleAfterObservation,levelObject.maxSampleAfterObservation);(0,_experimentJs.delay)(observationTime).then(function(){stateManager.newEvent(R.get.events_screenWentBlack,null,["stateRunningEventsLvl"+levelObject.level]),stateManager.call("setAgentOpacity",{opacity:0})});var blackoutTime=observationTime+levelObject.fixedBlackScreenDuration+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanBlackScreen,0,levelObject.maxSampleBlackScreen,levelObject.maxSampleBlackScreen);stateManager.newEvent(R.get.events_goNextPosition,blackoutTime,null,["stateRunningEventsLvl"+levelObject.level])}else if("observation_prediction"===sequenceObject.trialType[index]){var _observationTime=stateManager.timeInMs+levelObject.observationDuration+levelObject.fixedISIAfterObservation;_observationTime+=(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterObservation,0,levelObject.maxSampleAfterObservation,levelObject.maxSampleAfterObservation),(0,_experimentJs.debugWarn)("Observation Time",(_observationTime-stateManager.timeInMs)/1e3),stateManager.newEvent(R.get.events_startPrediction,_observationTime,["stateRunningEventsLvl"+levelObject.level])}else(0,_experimentJs.debugError)("Error in sequence",sequenceObject)}),"tryoutGoToNextPosition: finish sync call"},tryoutStartPrediction=function(){var _this2=this,state=this.state,stateManager=this.stateManager,R=stateManager.R,currentTutorial=stateManager.get("currentTutorial",1),levelObject=stateManager.get("levelObject");stateManager.promise("setAgentOpacity",{opacity:R.get.agent_predictionOpacity});var cross=stateManager.get("elements2D").cross;cross.spriteFrame=R.get.cross_predict;var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5),promise=Promise.resolve();if(1!==currentTutorial||R.get.predictionTest.passed)stateManager.call("drawPredictionTiles");else{stateManager.call("drawPredictionTiles",{withKeys:"dkmc"}),promise=stateManager.resolveOnKey({except:null}),stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,centerPosition.y-100)),text:R.get.predictionTest_message+"\n"+R.get.hitAKeyToContinue,duration:promise,event:new _experimentJs.EventData("predictionTextDismissed")});var text=R.get.changeCenterSquare;stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,-50)),text:text,duration:promise})}promise.then(function(){if(state.isPredicting=!0,state.isWaitingToPredict=new _experimentJs.Deferred,state.isWaitingToPredict.resolve(),state.currentTrialData.startPrediction=stateManager.timeInMs,1!==currentTutorial||R.get.predictionTest.passed)if(1===currentTutorial)stateManager.newEvent(R.get.events_responseTimeEnded,stateManager.timeInMs+levelObject.predictionDuration,null,["stateTryout"+currentTutorial]);else{stateManager.call("setAgentOpacity",{opacity:0});var endResponse=levelObject.predictionDuration;(0,_experimentJs.delay)(endResponse).then(function(){_this2.state.isPredicting=!1,null!==_this2.state.currentTrialData.choice?cross.spriteFrame=R.get.crossLockByPosition[_this2.state.currentTrialData.choice-1]:cross.spriteFrame=R.get.cross_base});var endPrediction=endResponse+levelObject.fixedISIAfterPrediction+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterPrediction,null,levelObject.maxSampleAfterPrediction,levelObject.maxSampleAfterPrediction);_this2.stateManager.newEvent(R.get.events_goNextPosition,endPrediction,null,["stateTryout"+currentTutorial])}else{var choiceDeferred=new _experimentJs.Deferred;state.choiceDeferred=choiceDeferred;var _text2=R.get.chooseNextPosition;stateManager.tooltip({position:centerPosition,background:null,text:_text2,duration:choiceDeferred.promise}),choiceDeferred.promise.then(function(){stateManager.newEvent(R.get.events_responseTimeEnded,stateManager.timeInMs+levelObject.predictionDuration,null,["stateTryout"+currentTutorial])})}})},tryoutCheckKeyStrokeForPrediction=function(){var event=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();if(void 0===event.data.keyCode)throw new Error("state.checkKeyStrokeForPrediction: event.data.keyCode is undefined");var stateManager=this.stateManager,state=this.state,R=this.R,currentTutorial=stateManager.get("currentTutorial",1),keyCode=event.data.keyCode,keyValue=event.data.key,keys={m:[77,3,R.get.cross_bottomRight],d:[68,1,R.get.cross_topLeft],c:[67,4,R.get.cross_bottomLeft],k:[75,2,R.get.cross_topRight]};_lodash2.default.has(state,"currentTrialData.keysHits")&&((0,_experimentJs.hasConstructor)(_experimentJs.Array,state.currentTrialData.keysHits)||(state.currentTrialData.keysHits=[]),state.currentTrialData.keysHits.push([keyValue,keyCode,stateManager.timeInMs]));var position=null,cross=1,chosenKey=null;for(var key in keys)if(keys.hasOwnProperty(key)){var keyPosition=keys[key];keyValue===key&&(position=keyPosition[1],cross=keyPosition[2],chosenKey=key)}if(null!==position){if(!0===state.isPredicting&&null!==state.currentTrialData.startPrediction&&null===state.currentTrialData.choice){if((0,_experimentJs.hasConstructor)(_experimentJs.Deferred,state.choiceDeferred)&&(state.choiceDeferred.resolve(),state.choiceDeferred=null),state.currentTrialData.choice=position,state.currentTrialData.responseTime=stateManager.timeInMs-state.currentTrialData.startPrediction,state.currentTrialData.respondedAt=stateManager.timeInMs,this.stateManager.get("elements2D").cross.spriteFrame=cross,!R.get.predictionTest.passed){R.get.predictionTest.numberOfPrediction+=1;var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5),tilePosition=stateManager.call("getTilePositions")[position-1],sign=Math.sign(centerPosition.subtract(tilePosition).x);tilePosition=tilePosition.add(new _experimentBabylonJs2.default.Vector2(50*sign,50*sign)),stateManager.tooltip({position:tilePosition,text:R.get.youSelectedThisTile+" ("+chosenKey+")",duration:(0,_experimentJs.delay)(2e3)});var text=R.get.aLittleSquareShowsYourChoice;stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,-50)),text:text,duration:2e3})}return state.numberOfMissed=0,stateManager.newEvent(R.get.events_hasResponded,null,null,["stateTryout"+currentTutorial]),(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: has chosen position "+position+"."),position}if((0,_experimentJs.hasConstructor)(_experimentJs.Deferred,state.isWaitingToPredict)&&state.isWaitingToPredict.pending){var background=new _experimentBabylonJs2.default.Color4(.7,.1,.1,.9);return stateManager.tooltip({position:new _experimentBabylonJs2.default.Vector2(this.taskObject.renderSize.width/2,this.taskObject.renderSize.height/2-100),text:R.get.tooEarly,background:background,duration:state.isWaitingToPredict}),state.isWaitingToPredict.resolve(),(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: too early"),!1}return(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: already chosen"),!1}return(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: not a valid time to choose or already chosen"),!1},tryoutEndPrediction=function(){var stateManager=this.stateManager,state=this.state,R=this.R,currentTutorial=stateManager.get("currentTutorial",1);return state.isPredicting=!1,state.currentTrialData.endPrediction=stateManager.timeInMs,stateManager.newEvent(R.get.events_goNextPosition,null,null,["stateTryout"+currentTutorial]),"state.endPrediction: resolved"},tryoutEnd=function(){var stateManager=this.stateManager,R=this.R,currentTutorial=stateManager.get("currentTutorial",1);this.taskObject.setCheckpoint(R.get.checkpoint_tutorialDone[currentTutorial-1])};exports.awakeTryout=awakeTryout,exports.tryoutEndPrediction=tryoutEndPrediction,exports.tryoutCheckKeyStrokeForPrediction=tryoutCheckKeyStrokeForPrediction,exports.tryoutGoToNextPosition=tryoutGoToNextPosition,exports.tryoutStartPrediction=tryoutStartPrediction,exports.tryoutEnd=tryoutEnd},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.tutorialUnfrozen=exports.awakeTutorial=exports.showModal=exports.showNextPage=void 0;var _experimentJs=__webpack_require__(0),_experimentBoxes=__webpack_require__(3),pageOrderTutorialOne=["intro","disclaimer","trialInstruction","arrowKeyboard","progressInstruction"],awakeTutorial=function(){var currentTutorial=this.stateManager.get("currentTutorial",1),pageOrder=pageOrderTutorialOne;this.stateManager.set("currentPage",pageOrder[0]);var showIntro=new _experimentJs.EventData(this.R.get.events_showModal,{page:pageOrder[0]});this.stateManager.addEvent(showIntro),this.stateManager.set("levelObject",{level:"tutorial-"+currentTutorial}),this.state.shouldPause=1!==currentTutorial},showModal=function(_ref){var _this=this,_ref$data$page=_ref.data.page,page=void 0===_ref$data$page?"intro":_ref$data$page,tutorials=this.R.get.tutorials;(0,_experimentJs.delay)(50).then(function(){if(tutorials.hasOwnProperty(page)){var tutorial=tutorials[page],event=new _experimentJs.EventData(_this.R.get.events_tutorialNext,{page:page});_this.taskObject.modal({type:"centralLarge",title:tutorial.title.en,content:tutorial.content.en,event:event}),_this.taskObject.currentModal.modalBox.buttonText="Next"}})},tutorialUnfrozen=function(){(0,_experimentJs.hasConstructor)(Object,this.taskObject.currentModal)&&(0,_experimentJs.hasConstructor)(_experimentBoxes.SmartModal,this.taskObject.currentModal.modalBox)&&this.taskObject.currentModal.modalBox.show()},showNextPage=function(_ref2){var _ref2$data$page=_ref2.data.page,currentPage=void 0===_ref2$data$page?this.stateManager.get("currentPage","intro"):_ref2$data$page,pageOrder=pageOrderTutorialOne,R=this.R,currentIndex=pageOrder.indexOf(currentPage);if(-1===currentIndex)throw new Error("state.showNextPage: invalid currentPage.");if(currentIndex!==pageOrder.length-1){var showEvent=new _experimentJs.EventData(R.get.events_showModal,{page:pageOrder[currentIndex+1]});this.stateManager.addEvent(showEvent)}else(0,_experimentJs.debuglog)("state.showNextPage: end of tutorial."),this.stateManager.goToState(R.get.states_running,!0)};exports.showNextPage=showNextPage,exports.showModal=showModal,exports.awakeTutorial=awakeTutorial,exports.tutorialUnfrozen=tutorialUnfrozen},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAspectRatio=exports.getDensity=exports.randomColor=exports.computeDurationEstimate=void 0;var _experimentMathjs=__webpack_require__(16),_experimentMathjs2=_interopRequireDefault(_experimentMathjs),_lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentJs=__webpack_require__(0),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),getAspectRatio=function(){var surfaceObject=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();if(surfaceObject.constructor===_experimentBabylonJs2.default.Texture){var _surfaceObject$getBas=surfaceObject.getBaseSize();return _surfaceObject$getBas.width/_surfaceObject$getBas.height}throw new Error("getAspectRatio: object type not valid.")},getDensity=function(elements){var nsteps=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(elements.some(isNaN))throw new Error("TaskObject.getDensity: elements are not all numeric.");for(var range=[_experimentMathjs2.default.min(elements),_experimentMathjs2.default.max(elements)],stepSize=(range[1]-range[0])/nsteps,elementsInWindow=[],windowPosition=[],density=[],points=[],i=0;i<nsteps;i++)!function(i){var subset=_lodash2.default.filter(elements,function(e){var centered=e-range[0]-i*stepSize;return centered>=0&&centered<stepSize});windowPosition[i]=(i+.5)*stepSize,elementsInWindow[i]=subset.length,density[i]=elementsInWindow[i]/elements.length,points[i]={x:windowPosition[i],y:density[i]}}(i);return{windows:{position:windowPosition,numberOfElements:elementsInWindow,density:density},points:points,chartOptions:{type:"line",data:{datasets:[{label:"Density",data:points}]},options:{scales:{xAxes:[{type:"linear",position:"bottom"}]}}}}},randomColor=function(opacity){return"rgba("+Math.round(255*Math.random())+","+Math.round(255*Math.random())+","+Math.round(255*Math.random())+","+(opacity||".3")+")"},computeDurationEstimate=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},parametersBase={dominantProbability:.76,minNumberOfObservationsPerLearning:3,maxNumberOfObservationsPerLearning:7,observationDuration:500,interObservationDuration:50,minTimeToPredict:2e3,maxTimeToPredict:5e3,feedbackDuration:500,minISIAfterLearning:1e3,maxISIAfterLearning:1500,minISIAfterFeedback:3e3,maxISIAfterFeedback:5e3,rabbitAutoTransition:!1,rabbitDominantProbability:.6,observationSegmentSizes:[3,4,5],observationSegmentRepetitionPerBlock:2,numberOfBlocks:6,numberOfRandomBlocks:2,feedbackType:"transition"};options=_lodash2.default.extend(parametersBase,options);var numberOfObservationPerLevel=_experimentMathjs2.default.sum(options.observationSegmentSizes)*options.observationSegmentRepetitionPerBlock,oneObservationDuration=options.observationDuration,observationsDurationPerBlock=numberOfObservationPerLevel*oneObservationDuration,numberOfPredictionEventsPerBlock=options.observationSegmentSizes.length*options.observationSegmentRepetitionPerBlock,timeDurationMatrix=_experimentMathjs2.default.matrix([[options.minISIAfterLearning,options.maxISIAfterLearning],[options.minTimeToPredict,options.maxTimeToPredict],[options.feedbackDuration,options.feedbackDuration],[options.maxISIAfterFeedback,options.maxISIAfterFeedback]]),factorMatrix=_experimentMathjs2.default.matrix([[1,0,.5],[0,1,.5]]),predictionDurationMatrix=_experimentMathjs2.default.multiply(timeDurationMatrix,factorMatrix),sumPredictionDurationVector=_experimentMathjs2.default.multiply(_experimentMathjs2.default.matrix([1,1,1,1]),predictionDurationMatrix),predictionsDurationPerBlock=_experimentMathjs2.default.multiply(sumPredictionDurationVector,numberOfPredictionEventsPerBlock),observationDurationMatrix=_experimentMathjs2.default.matrix((0,_experimentJs.rep)(observationsDurationPerBlock,3)),durationPerBlock=_experimentMathjs2.default.add(observationDurationMatrix,predictionsDurationPerBlock),totalDuration=_experimentMathjs2.default.multiply(durationPerBlock,options.numberOfBlocks+options.numberOfRandomBlocks).toArray();return{min:totalDuration[0],max:totalDuration[1],mean:totalDuration[2]}};exports.computeDurationEstimate=computeDurationEstimate,exports.randomColor=randomColor,exports.getDensity=getDensity,exports.getAspectRatio=getAspectRatio},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_16__},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_17__}])});